<!-- templates/vitamin_d_helper.html -->
{% extends 'base.html' %}
{% load static %}
{% load uv_filters %}
<!-- Embedded Timer -->
{% include 'timer/timer_component.html' with initial_seconds=timer_seconds
recommended_minutes=recommendation.max_minutes %}

{% block extra_css %}
<style>
    .location-status {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
    }

    .location-active {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .location-inactive {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
    }

    #detect-location.loading {
        opacity: 0.7;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2>Vitamin D Helper</h2>

    <!-- Skin Type Selection -->
    <div class="card mb-4">
        <div class="card-header">
            <h3>Select Your Skin Type</h3>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" name="skin_type_submit" class="btn btn-primary">Save Skin Type</button>
            </form>
        </div>
    </div>

    <!-- Location Settings -->
    <div class="card mb-4">
        <div class="card-header">
            <h3>Location Settings</h3>
        </div>
        <div class="card-body">
            <!-- Manual City Form -->
            <form method="post">
                {% csrf_token %}
                <div class="mb-3">
                    <label class="form-label">Melbourne Suburb or City</label>
                    {{ city_form.city }}
                    <div class="form-text">Enter your Melbourne suburb or Victorian city</div>
                </div>
                <button type="submit" name="city_submit" class="btn btn-primary">Save Location</button>
            </form>

            <hr>

            <!-- Auto-detect Location -->
            <div class="text-center">
                <p>Or detect your location automatically:</p>
                <button id="detect-location" class="btn btn-outline-primary">
                    <i class="bi bi-geo-alt"></i> Detect My Location
                </button>
                <div id="location-status" class="mt-2 small text-muted"></div>
            </div>
        </div>
    </div>

    <!-- Location Status Display -->
    <div class="location-status {% if has_location %}location-active{% else %}location-inactive{% endif %}">
        <i class="bi bi-{% if has_location %}geo-alt-fill{% else %}geo-alt{% endif %}"></i>
        {% if profile.city and profile.city != 'Melbourne' %}
        Using location: {{ profile.city }}, Australia
        {% elif profile.has_location %}
        Using detected location
        {% else %}
        Using default location: Melbourne, Australia
        {% endif %}
    </div>

    <!-- Weather Conditions -->
    {% if weather_data %}
    <div class="card mb-4">
        <div class="card-header">
            <h3>Today's Conditions</h3>
        </div>
        <div class="card-body">
            <p><strong>Location:</strong> {{ weather_data.location }}</p>
            <p><strong>Condition:</strong> {{ weather_data.condition }}</p>
            <p><strong>Temperature:</strong> {{ weather_data.temp }}°C</p>
            <p><strong>UV Index:</strong> {{ weather_data.uv_index }} ({{ weather_data.uv_index|uv_index_level }})</p>

            {% if is_good_conditions %}
            <div class="alert alert-success">
                <i class="bi bi-sun"></i> Good conditions for safe sun exposure!
            </div>
            {% else %}
            <div class="alert alert-warning">
                <i class="bi bi-cloud"></i> Conditions may not be ideal for sun exposure.
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Recommendations -->
    {% if recommendation %}
    <div class="card">
        <div class="card-header">
            <h3>Recommended Sun Exposure</h3>
        </div>
        <div class="card-body">
            <p>Based on your skin type, recommended exposure time:</p>
            <h4 class="text-primary">{{ recommendation.min_minutes }} - {{ recommendation.max_minutes }} minutes</h4>
            <p class="text-muted small">
                <i class="bi bi-info-circle"></i>
                This recommendation is for optimal vitamin D production without burning.
            </p>
            <!-- Sun Exposure Countdown (inline, uses {{ timer_seconds }} from context) -->
            <div id="vd-card" class="card mt-4" data-initial-seconds="{{ timer_seconds|default:900 }}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Sun Exposure Timer</h4>
                    <!-- <span class="text-muted small">
                        Initial: {{ timer_seconds|default:900 }} sec
                    </span> -->
                </div>

                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-12 col-md-4">
                            <label for="vd-mins" class="form-label">Duration (minutes)</label>
                            <input id="vd-mins" type="number" class="form-control" min="1" max="180" step="1"
                                value="15">
                            <div class="form-text">Change and press Reset to apply.</div>
                        </div>

                        <div class="col-12 col-md-8 text-center">
                            <div id="vd-display" class="display-3 fw-bold" aria-live="polite">15:00</div>
                            <div id="vd-status" class="small text-muted"></div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex gap-2 flex-wrap">
                        <button id="vd-start" class="btn btn-success">Start</button>
                        <button id="vd-pause" class="btn btn-warning" disabled>Pause</button>
                        <button id="vd-reset" class="btn btn-secondary" disabled>Reset</button>
                    </div>

                    <audio id="vd-beep">
                        <source src="https://www.soundjay.com/buttons/beep-01a.wav" type="audio/wav">
                    </audio>
                </div>
            </div>

            <script>
                (function () {
                    // Grab initial seconds from data attribute (falls back to 900 if missing/invalid)
                    const card = document.getElementById('vd-card');
                    const initialSec = Math.max(0, Number(card?.dataset?.initialSeconds) || 900);

                    // Elements
                    const elMins = document.getElementById('vd-mins');
                    const elDisplay = document.getElementById('vd-display');
                    const elStatus = document.getElementById('vd-status');
                    const btnStart = document.getElementById('vd-start');
                    const btnPause = document.getElementById('vd-pause');
                    const btnReset = document.getElementById('vd-reset');
                    const beep = document.getElementById('vd-beep');

                    // State: start with timer_seconds
                    let total = initialSec;        // seconds
                    let remaining = total;
                    let running = false;
                    let tick = null;

                    // Set the minutes input to reflect the initial seconds
                    elMins.value = Math.max(1, Math.min(180, Math.round(total / 60)));

                    // Helpers
                    function fmt(sec) {
                        sec = Math.max(0, Math.floor(sec));
                        const m = Math.floor(sec / 60);
                        const s = sec % 60;
                        return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                    }
                    function render() {
                        elDisplay.textContent = fmt(remaining);
                        elStatus.textContent = running ? 'Running…' : (remaining === 0 ? 'Done' : 'Paused');
                        btnStart.disabled = running || remaining <= 0;
                        btnPause.disabled = !running;
                        btnReset.disabled = running || (remaining === total);
                    }
                    function stop() {
                        running = false;
                        if (tick) { clearInterval(tick); tick = null; }
                        render();
                    }
                    function start() {
                        if (remaining <= 0) return;
                        running = true;
                        tick = setInterval(() => {
                            remaining -= 1;
                            if (remaining <= 0) {
                                remaining = 0;
                                stop();
                                try { beep && beep.play && beep.play(); } catch (_) { }
                            }
                            render();
                        }, 1000);
                        render();
                    }
                    function reset() {
                        stop();
                        // Apply minutes input to total
                        const mins = Math.max(1, Math.min(180, Number(elMins.value) || 1));
                        total = mins * 60;
                        remaining = total;
                        render();
                    }

                    // Wire up
                    btnStart.addEventListener('click', start);
                    btnPause.addEventListener('click', stop);
                    btnReset.addEventListener('click', reset);

                    // If the user edits minutes while paused, don’t change the countdown until Reset
                    elMins.addEventListener('change', () => {
                        if (!running) {
                            // just update the display preview to what Reset would set
                            const mins = Math.max(1, Math.min(180, Number(elMins.value) || 1));
                            elDisplay.textContent = fmt(mins * 60);
                            elStatus.textContent = 'Paused';
                            btnReset.disabled = false;
                            btnStart.disabled = false;
                        }
                    });

                    // Initial render based on timer_seconds
                    render();
                })();
            </script>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const detectButton = document.getElementById('detect-location');
        const statusDiv = document.getElementById('location-status');

        detectButton.addEventListener('click', function () {
            if (!navigator.geolocation) {
                statusDiv.textContent = 'Geolocation is not supported by your browser';
                statusDiv.className = 'mt-2 small text-danger';
                return;
            }

            // Show loading state
            detectButton.classList.add('loading');
            statusDiv.textContent = 'Detecting your location...';
            statusDiv.className = 'mt-2 small text-info';

            navigator.geolocation.getCurrentPosition(
                function (position) {
                    statusDiv.textContent = 'Location detected! Saving...';

                    // Send coordinates to server
                    fetch('{% url "update_location_from_coords" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                statusDiv.textContent = 'Location saved successfully! Reloading...';
                                statusDiv.className = 'mt-2 small text-success';

                                // Reload page after a short delay to show updated weather
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            } else {
                                statusDiv.textContent = 'Error: ' + data.error;
                                statusDiv.className = 'mt-2 small text-danger';
                                detectButton.classList.remove('loading');
                            }
                        })
                        .catch(error => {
                            statusDiv.textContent = 'Error saving location: ' + error;
                            statusDiv.className = 'mt-2 small text-danger';
                            detectButton.classList.remove('loading');
                        });
                },
                function (error) {
                    let errorMessage;
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied. Please allow location access in your browser settings.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out.';
                            break;
                        default:
                            errorMessage = 'Unknown error occurred.';
                    }
                    statusDiv.textContent = errorMessage;
                    statusDiv.className = 'mt-2 small text-danger';
                    detectButton.classList.remove('loading');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 600000
                }
            );
        });
    });
</script>
{% endblock %}